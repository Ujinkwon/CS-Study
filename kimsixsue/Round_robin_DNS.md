[Round robin DNS](#round-robin-dns)

* [Pros](#pros)
* [Cons](#cons)
* [Scheduling](#scheduling)
  + [Static](#static)
  + [Dynamic](#dynamic)
* [References](#references)

# Round robin DNS

- [**DNS**(Domain Name System)](https://ko.wikipedia.org/wiki/%EB%8F%84%EB%A9%94%EC%9D%B8_%EB%84%A4%EC%9E%84_%EC%8B%9C%EC%8A%A4%ED%85%9C)는 일반적으로 호스트 이름을 IP 주소 하나에 매핑합니다.

- [Round robin](https://ko.wikipedia.org/wiki/%EB%9D%BC%EC%9A%B4%EB%93%9C_%EB%A1%9C%EB%B9%88_%EC%8A%A4%EC%BC%80%EC%A4%84%EB%A7%81)은 “순서대로, 즉 교대로”라는 의미입니다.

[NCSA(일리노이)](https://www.ncsa.illinois.edu/)에서 처음으로 분산된 서버들의 부하분산을 위하여, DNS의 호스트를 이용한 Round-Robin DNS 방식을 사용하였다. 

DNS Round robin은 1개의 domain name에 대해서, 여러 개의 IP 주소를 DNS 서버에 등록해두고, client로부터 DNS 서버에 **URL**(Uniform Resource Locator)에 대한 DNS 질의 요청이 오면, DNS 서버가 등록된 IP 주소를 순서대로 매핑, 분배, 전달하는 것입니다. 전달되는 IP 주소가 바뀌기 때문에, 각 client가 접속하는 IP 주소도 다르게 됩니다.

- 웹서버 자체를 여러 개의 서버로 분산. 

- IP Based Virtual Host : 하나의 도메인에 여러 IP 할당. 
- 서버 용량이 더 많이 필요하면 관리자는 순환 목록에 IP 주소를 추가하고, 서버 팜(클러스터)에 서버를 추가할 수 있습니다. DNS round-robin 방식에 의한 서버 확장은 각 서버에 mirror 된 데이터 가 있다는 것을 전제로 합니다.

## Pros

DNS 서버에 설정만 조금 추가하면, 트래픽 분산을 할 수 있으며, 별도의 장비를 구매하지 않아도 됩니다. 

설치가 간단하고, 부하를 분산하는 디스패처가 없어서, 한 서버가 장애로 서비스를 할 수 없게 되어도, 전체 시스템에 영향을 미치지 않는다. 즉, **SPOF**(**Single Point Of Failure**)가 발생하지 않는 장점이 있다. 

## Cons

서버의 현재 상태를 고려하지 않는 부하 분산의 한계로 해결하기 어려운 문제를 몇 가지 수반합니다.

1. 서버의 부하를 고려하지 않는다.

   - 균등한 load-balancing을 구현하기 어렵습니다. 처음에 client는 DNS 서버에 접속한 후에 얻은 정보를 cache에 보관하게 됩니다. 그래서 cache 정보가 사라지기 전까지는 계속 같은 서버에 접속하다 보니, 서버 간에 균등한 load-balancing을 구현하기 어렵습니다. 

   - 순환으로 인한 system bias 시스템 편향 문제입니다. 즉, 개별 서버들 간에 불평등하고, 매우 가변적이며, 예기치 못한 로드 분산이 이루어지는 것입니다. 시스템 편향으로 인하여 서버 시스템의 잠재적 총용량이 낮아지기 때문에, 기업들은 서버 용량에 필요 이상의 투자를 해야 합니다

2. DNS는 서버들의 상태를 파악할 수 없어서, 장애가 발생한 서버에도 사용자 요청을 할당하도록 하는 단점이 있다.

   - 실제 서버에게 장애가 생겨도, DNS 서버는 해당 서버가 장애가 발생했다는 사실을 알 수 없습니다. 결국 DNS 서버는 client에, 장애가 발생한 서버의 IP 주소를 계속 전달하게 됩니다. 
   - TCP 연결, 서버 또는 애플리케이션의 상태를 전혀 모르기 때문에, 가용성 문제를 제기합니다. 한 서버가 충돌을 일으켜도, 계속해서 충돌이 발생한 서버에 클라이언트 요청을 전송하게 되고, 클라이언트는“서버를 사용할 수 없습니다”라는 메시지를 받게 됩니다. 관리자가 설정을 수동으로 조정하여, 충돌을 일으킨 서버(또는 다른 서버)를 DNS round-robin에서 제거하면, DNS는 자체 IP 주소에 근거하여 제거된 서버에 클라이언트를 계속해서 지정하기도 합니다.

3. DNS의 특성상, 클라이언트에서 캐싱으로 인한 부하의 불균형이 발생한다. 

   - client의 traffic type을 반영하지 못합니다, 즉 client의 device(tablet, phone, PC) 구분을 못 해서, 해당 서비스를 제공하는 최상의 서버를 정확히 선택을 못 합니다. 
   - 캐시 된 정보를 사용한 여러 서버로의 액세스도 문제가 있습니다. redundancy 리던던시를 최소화하고 효율성을 극대화하려는 시도로 DNS는 이미 검색한 데이터를 “기억”하게 하는 캐싱 메커니즘을 사용합니다. 특정 IP 매핑이 순환 목록에서 제거되었더라도, 일부 캐시는 계속해서 그 정보를 보유할 수 있습니다. 이러한 캐시로는 완전한 웹 페이지, dataset 또는 애플리케이션을 클라이언트에 전달하는 데 필요한 나머지 정보를 찾기 위한 서버에 액세스할 수 없습니다.

## Scheduling

DNS Round-Robin의 단점을 해결한, Load-balancer 부하 분산장치의 Scheduling Algorithms 작업 할당 방식

### Static

서버의 현재 상태를 고려하지 않는 부하 분산 기법 

Round-Robin 방식들은 서버에 대한 어떠한 load information 부하 정보도 가지고 있지 않기 때문에 self-explanatory 자명하다. 

1. **R**ound-**R**obin Scheduling 라운드 로빈 스케줄링

   - cache 된 DNS 질의에 의해 불균등하게 분산되지 않음
   - Round-Robin DNS 방식과 유사하지만, 호스트 기반이 아닌 네트워크 연결 기반의 더 세분된 방식

   - 부하 분산장치는 client로부터 받은 요청을 부하분산 대상 서버에 순서대로 할당하는 방식입니다. 부하분산 대상 서버의 성능이 같고 처리시간이 짧은 application(예 : web 서비스)일 때는 균등한 부하분산이 이루어집니다. 하지만 처리시간이 긴 ftp 등의 서비스 환경에서는 맞지 않습니다. 
   - Round-Robin 방식을 이용해 네트워크 연결을 서로 다른 서버에 연결하는 것을 말한다. 이 경우 실제 서버의 연결개수나 반응시간 등은 고려하지 않는다. 그렇지만 약간의 차이가 있다. Round-Robin DNS는 단일한 도메인을 서로 다른 IP로 해석하지만, 스케줄링의 기초는 호스트 기반이며 캐싱 때문에 알고리즘을 효율적으로 사용하기 힘들다. 그래서 실제 서버 사이에 동적인 부하 불균형이 심각해질 수 있다. 가상 서버의 스케줄링 기초는 네트워크 기반이며 Round-Robin DNS에 비해 훨씬 더 훌륭하다. 

2. **W**eighted **R**ound-**R**obin Scheduling 가중치 기반 라운드 로빈 스케줄링

   - 서버별로 가중치를 설정해두고, 그 weight 가중치에 따라 요청을 서버에 할당하는 방식입니다. 성능이 낮은 서버에 낮은 가중치를 설정하고, 성능이 높은 서버에 높은 가중치를 설정합니다. 이 방식은 부하분산 대상 서버의 성능, 용량에 차이가 있을 때 선택할 수 있습니다.
     - 요청 부하량이 아주 다양할 경우 더 가중치가 있는 서버가 요청 공유량보다 더 많이 응답할 수 있음
   - 실제 서버에 서로 다른 처리 용량을 지정할 수 있다. 각 서버에 가중치를 부여할 수 있으며, 여기서 지정한 정숫값을 통해 처리 용량을 정한다. 기본 가중치는 1이다. 
     - 예를 들어 실제 서버가 A, B, C이고 각각의 가중치가 4, 3, 2일 경우 스케줄링 순서는 ABCABCABA가 된다. 
   - 실제 서버에서 네트워크 접속을 셀 필요가 없고 스케줄링의 과부하가 적으므로, 더 많은 실제 서버를 운영할 수 있다.
   - Round-Robin 스케줄링은 가중치 기반 Round-Robin 스케줄링의 특별한 한 종류이며 모든 가중치가 같은 경우이다. 
     - 가상 서버의 규칙을 변경하고 나서 스케줄링 순서를 생성하는 데는 거의 과부하가 걸리지 않으며, 실제 스케줄링에 어떠한 과부하도 추가하지 않는다. 그러므로 Round-Robin 스케줄링만 단독으로 실행하는 것은 불필요한 일이다.
   - 요청에 대한 부하가 매우 많을 때 실제 서버 사이에 동적인 부하 불균형 상태가 생길 수 있다.

3. active/standby 방식

   - 평상시에는 active 장비만 사용하고, active 장비에 장애가 발생했을 때만, standby 장비를 사용합니다. 
   - 이 방식은 부하분산이라기보다는 서버 이중화를 위한 기능입니다.

### Dynamic

서버의 현재 상태를 반영하는 부하 분산 기법

Least-Connection 방식들은 각 서버에 대한 active connection number 활동 접속 수를 세어 이러한 connection number에 의해 그들의 부하를 추정한다. 

1. **L**east-**C**onnection Scheduling 최소 접속(연결) 스케줄링

   - 부하 분산장치가 요청받는 시점에서 가장 연결 수가 적은 서버를 선택하여 요청을 할당합니다. 연결을 길게 지속해야 하는 애플리케이션을 부하분산 할 때 적합합니다
     - 동적인 스케줄링 알고리즘 유형 중 하나로 실제 서버로의 라이브 연결을 추적하기 때문에 요청 부하에 극도로 다양한 처리량이 있을 때 유용
     - 각각의 노드에 대략 비슷한 처리 용량이 있는 실제 서버 풀도 적합
   - 실제 서버 중에서 현재 가장 적은 수의 요청을 처리하고 있는 서버를 선택하여, 요청 패킷을 할당하는 방식
     - 가장 접속이 적은 실제 서버로 더 많은 요청을 배분하는 방식

   - 가장 접속이 적은 서버로 요청을 직접 연결하는 방식을 말한다. 각 서버에서 동적으로 실제 접속한 숫자를 세어야 하므로 동적인 스케줄링 알고리즘 중의 하나이다. 비슷한 성능의 서버로 구성된 가상 서버는 아주 큰 요구가 한 서버로만 집중되지 않기 때문에, 접속부하가 매우 큰 경우에도 아주 효과적으로 분산을 한다. 
     - 가장 빠른 서버에서 더 많은 네트워크 접속을 처리할 수 있다. 그러므로 다양한 처리 용량을 지닌 서버로 구성했을 때도 훌륭하게 작동한다는 것을 한눈에 알 수 있을 것이다. 
   - 실제로는 TCP 의 TIME_WAIT 상태 때문에 아주 좋은 성능을 낼 수는 없다. 
     - TCP 의 TIME_WAIT는 보통 2분이다. 그런데 접속자가 아주 많은 웹 사이트는 2분 동안에 몇천 개의 접속을 처리해야 할 경우가 있다. 서버 A는 서버 B보다 처리용량이 두 배일 경우 서버 A는 수천 개의 요청을 처리하고 TCP 의 TIME_WAIT 상황에 직면하게 된다. 그렇지만 서버 B는 몇천 개의 요청이 처리되기만을 기다리게 된다. 
     - 그래서 최소 접속 스케줄링을 이용하면 다양한 처리용량을 지난 서버로 구성되었을 경우 부하분산이 효율적으로 되지 못할 수 있는 것이다. 

2. **W**eighted **L**east-**C**onnection Scheduling 가중치 기반 최소 접속(연결) 스케줄링

   - 기본적으로 최소 연결 방식인데, weighted round robin 방식과 마찬가지로 각 서버에 서로 다른 가중치를 주어서 할당하는 방식

     - 관리자는 실제 서버 풀에 있는 각각의 노드에 가중치를 부여 가능

   - 가중치는 정숫값으로 모든 가중치 관련 스케줄링 알고리즘 영향을 미치며 라우터가 다른 처리 용량이 있는 하드웨어를 더 균등하게 로드

   - 최소 접속 스케줄링 알고리즘에 비해 부가적인 배분 작업이 필요하다. 서버들이 같은 처리 용량을 가졌을 때는 작업 할당의 간접 비용을 최소화하기 위해, 최소 접속 스케줄링과 가중치가 있는 최소 접속 스케줄링 알고리즘 둘 다 사용할 수 있다. 

   - 최소 접속 스케줄링의 한 부분으로서 각각의 실제 서버에 성능 가중치를 부여할 수 있다. 언제라도 가중치가 높은 서버에서 더 많은 요청을 받을 수 있다. 가상 서버의 관리자는 각각의 실제 서버에 가중치를 부여할 수 있다. 가중치의 비율인 실제 접속자 수에 따라 네트워크 접속이 할당된다. 기본 가중치는 1이다. 가중치가 있는 최소 접속 스케줄링은 다음과 같이 작동한다:

     - n 개의 실제 서버가 있는 경우 각 서버 i는 가중치 Wi (i = 1, ... , n)를 가진다고 가정하자. 서버 i의 활동 접속(active connection)은 Ci (i = 1, ... , n)이고 모든_접속은 Ci (i = 1, ... , n)의 합이다. 서버 j로 가는 네트워크 접속은 아래와 같다. 

       >  (Cj/ALL_CONNECTIONS)/Wj = min { (Ci/ALL_CONNECTIONS)/Wi } (i=1,..,n) 

     - 이 비교에서 ALL_CONNECTIONS는 상수이므로 Ci를 모든_접속으로 나눠줄 필요가 없다. 그러면 다음과 갈이 최적화될 것이다. 

       >  Cj/Wj = min { Ci/Wi } (i=1,..,n) 

3. **L**ocality-**B**ased **L**east-**C**onnection Scheduling

   - 목적지 IP와 관련하여 가장 접속이 적은 서버로 더 많은 요청을 배분하는 방식
     - 서버가 서버 처리 용량을 초과하지 않고 서버가 반부하 상태에 있지 않을 때, IP 주소를 최소로 부하 된 실제 서버로 할당하여, IP 주소의 패킷을 해당 주소의 서버로 라우팅
   - 알고리즘은 proxy-cache 서버 클러스터(팜) 사용

4. **L**ocality-**B**ased **L**east-**C**onnection Scheduling with Replication Scheduling

   - 목적지 IP와 관련하여 가장 접속이 적은 서버로 더 많은 요청을 배분하는 방식
     - 목적지 IP 주소에 대해 모든 노드가 처리 용량을 초과할 때, 가장 접속이 적은 실제 서버를 실제 서버의 전체 풀에서 목적지 IP의 실제 서버에 대한 subnet으로 추가하여, 해당 목적지 IP 주소에 대한 새로운 서버를 복사
   - 알고리즘은 proxy-cache 서버 클러스터(팜) 사용
   - 대상 IP 주소를 실제 서버 노드의 subset으로 묶는다는 점에서 LBLC 스케줄링과 다름
   - subnet에 있는 가장 접속이 적은 서버로 요청을 라우팅
   - 최고로 과부하 된 노드는 실제 서버 서브넷에서 제외

5. Fastest(최단 응답시간) 방식

   - 부하 분산장치는 client로부터 받은 요청과 서버의 응답 사이의 시간을 계속 확인합니다. 이때 부하 분산장치는 요청받으면 가장 빠르게 응답하는 서버를 선택해서 할당하는 방식입니다.

6. **L**east **L**oaded 방식

   - 각 서버는 주기적으로 CPU, 메모리 사용량 정보를 **SNMP**(**simple network management protocol**)를 이용해서 부하 분산장치에 알려줍니다. 부하 분산장치가 요청받으면 취득한 정보를 바탕으로, 부하가 가장 적은 서버에 할당합니다.
   - 다른 방식보다 정보의 신뢰성은 높지만, 그 정보가 실시간 정보가 아니라는 문제점이 있습니다.
   - 이것을 사용하기 위해서는 서버에 SNMP agent가 설치되어 있어야 하며, SNMP에서 사용하는 **MIB**(**management information base**)의 값이 해당 서버의 load 부하를 표현할 수 있어야 합니다.

## References

[2018 / 공개SW 포털 / nipa 공개SW역량프라자 / 미들웨어> 분산시스템SW ](https://www.oss.kr/storage/app/public/oss/13/66/021_[LVS]%20Solution%20Guide%20V0.4_20181204.pdf)

[2016 / 방송과 기술 / SAVVY & TREND / KBS 보도기술국 김해중 / 실무 네트워크 Design - 12 : SLB, Server Load Balancing](http://tech.kobeta.com/wp-content/uploads/2016/10/24317.pdf)

[2005 / 클루닉스 단독대표이사 서진우 / 리눅스 클러스터 기술 백서](http://syszone.co.kr/PDF/linux_cluster_alang.pdf)

[2004 / 숭실대학교 컴퓨터학과 / 한국정보처리학회 춘계학술발표대회 / 확장 DNS를 이용한 분산 웹 서버의 동적 부하분산 기술](https://koreascience.kr/article/CFKO200423367096719.pdf)

[2002 / Cisco / 로드 밸런싱](https://www.cisco.com/c/dam/global/ko_kr/products/pc/cnd/400/lobal-wp.pdf)
